// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts,
// or vendor/assets/javascripts of plugins, if any, can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// the compiled file.
//
// WARNING: THE FIRST BLANK LINE MARKS THE END OF WHAT'S TO BE PROCESSED, ANY BLANK LINE SHOULD
// GO AFTER THE REQUIRES BELOW.
//
//= require jquery
//= require jquery_ujs

//= require browser_timezone_rails/application.js

//= require ext-all-debug
//= require ListMenu
//= require RangeMenu
//= require Filter
//= require FiltersFeature
//= require BooleanFilter
//= require DateFilter
//= require ListFilter
//= require NumericFilter
//= require StringFilter
//= require StatusBar
//= require stativus
//= require signature_capture
//= require LayerModel
//= require LayerStore
//= require Viewport
//= require MessageBox
//= require Map
//= require Action
//= require GeocoderComboBox
//= require XTemplate
//= require OpenLayers
//= require /javascripts/loader.js
//= require Ux.InputTextMask
//= require filter_row
//= require netzke
//= require episodes_list
//= require documents/abstract_document_form.js
//= require documents/oasis_container_form_panel.js
//= require documents/patient_wound_type.js
//= require documents/patient_primary_wound_type.js
//= require documents/neuro_emotional_behavioural_m1700_m1730.js
//= require documents/neuro_emotional_behavioural_m1700_m1730_poc.js
//= require documents/neuro_emotional_behavioural2_m1740_m1750.js
//= require documents/neuro_emotional_behavioural2_m1740_m1750_poc.js
//= require documents/adl_iadls1_m1800_m1830.js
//= require documents/adl_iadls2_m1840_m1870.js
//= require documents/adl_iadls3_m1880_m1890.js
//= require documents/adl_iadls4_m1900_m1910.js
//= require documents/fall_risk_management.js
//= require documents/functional_limitations.js
//= require documents/supplies_equipment.js
//= require documents/activities_permitted.js
//= require documents/musculoskeletal.js
//= require documents/medications_m2000_m2030.js
//= require documents/medications_poc_medicational_status.js
//= require documents/medications_poc_iv_supplies.js
//= require documents/medications_poc_infusion.js
//= require documents/medications_poc_allergies.js
//= require documents/medications2_m2040.js
//= require documents/medications2_m2040_c1.js
//= require documents/types_sources_of_assistance_m2100.js
//= require documents/types_sources_of_assistance_m2102_c1.js
//= require documents/types_sources_of_assistance.js
//= require documents/adliadl_assistance_m2110.js
//= require documents/therapy_need_m2200.js
//= require documents/plan_of_care_m2250.js
//= require documents/plan_of_care_m2250_c1.js
//= require documents/poc.js
//= require documents/general_patient_information_m0010_m0140.js
//= require documents/payment_source_m0150.js
//= require documents/clinical_record_items_m0080_m0110.js
//= require documents/in_patient_discharge_m1000_m1005.js
//= require documents/in_patient_discharge_m1000_m1005_c1.js
//= require documents/diagnosis_and_procedure_codes_m1010_m1012.js
//= require documents/diagnosis_and_procedure_codes_m1010_m1012_c1.js
//= require documents/diagnoses_regimen_change_m1016_m1018.js
//= require documents/diagnoses_regimen_change_m1017_m1018.js
//= require documents/patient_history_and_diagnosis.js
//= require documents/diagnosis_symptom_payment.js
//= require documents/diagnosis_symptom_payment_icd10.js
//= require documents/primary_payment_m1020_m1024.js
//= require documents/primary_payment_m1021_m1025.js
//= require documents/primary_payment_m1022_m1024.js
//= require documents/primary_payment_m1023_m1025.js
//= require documents/status_risk_vaccine_m1030_m1036.js
//= require documents/status_risk_vaccine_m1030_m1036_c1.js
//= require documents/living_arrangment_m1100.js
//= require documents/living_arrangements_poc.js
//= require documents/sensory_status_m1200_m1230.js
//= require documents/sensory_status_poc.js
//= require documents/pain_care_plan_m1240_m1242.js
//= require documents/care_plan_poc.js
//= require documents/integumentary_status_m1300_m1306.js
//= require documents/integumentary_poc_component.js
//= require documents/integumentary_status_m1306_m1307.js
//= require documents/integumentry_status2_m1308_soc_roc.js
//= require documents/integumentry_status2_m1308.js
//= require documents/pressure_ulser_m1310_m1324.js
//= require documents/stasis_ulcer_wound_m1330_m1350.js
//= require documents/stasis_ulcer_wound_m1330_m1350_c1.js
//= require documents/respiratory_cardac_m1400_m1410.js
//= require documents/breath_sounds.js
//= require documents/heart_sounds.js
//= require documents/elimination_m1600_m1630.js
//= require documents/genitourinary.js
//= require documents/urinary_dme_supplies.js
//= require documents/miscellaneous.js
//= require documents/foley_supplies.js
//= require documents/nutritionalstatus.js
//= require documents/eternalfeedings.js
//= require documents/elimination.js
//= require documents/abdomen.js
//= require documents/genitalia.js
//= require documents/general_patient_information_m0010_m0069.js
//= require documents/clinical_record_items_m0080_m0100.js
//= require documents/clinical_record_items_m0110.js
//= require documents/status_risk_vaccine_m1030.js
//= require documents/sensory_status_m1200.js
//= require documents/integumentary_status_m1306.js
//= require documents/pressure_ulser_m1322_m1324.js
//= require documents/respiratory_cardiac_m1400.js
//= require documents/elimination_m1610_m1630.js
//= require documents/elimination_m1610_m1630_c1.js
//= require documents/adliadLs1_m1810_m1830.js
//= require documents/adliadLs2_m1840_m1860.js
//= require documents/medications_m2030.js
//= require documents/status_risk_vaccine_m1040_m1055.js
//= require documents/respiratory_cardiac_m1500_m1510.js
//= require documents/emergent_care_m2300_m2310.js
//= require documents/intervention_synopsis_m2400.js
//= require documents/intervention_synopsis_m2400_c1.js
//= require documents/inpatient_facility_m2410_m2440.js
//= require documents/inpatient_facility_m2410_m2430_c1.js
//= require documents/medications_m2004_m2015.js
//= require documents/sensory_status_m1230_m1242.js
//= require documents/respiratory_cardiac_m1400_m1510.js
//= require documents/elimination_m1600_m1620.js
//= require documents/neuro_emotional_behavioural_m1700_m1720.js
//= require documents/neuro_emotional_behavioural2_m1740_m1745.js
//= require documents/neuro_emotional_behavioural_m1700_m1730_c1.js
//= require documents/medications_m2004_m2030.js
//= require documents/inpatient_facility_m2410_m2420.js
//= require documents/discharge_dates_m0903_m0906.js
//= require documents/integumentary_status_m1300_m1306_c1.js
//= require documents/integumentry_status2_m1308_soc_roc_c1.js
//= require documents/integumentary_status_m1306_m1307_c1.js
//= require documents/integumentry_status2_m1308_c1.js
//= require documents/pressure_ulser_m1310_m1324_c1.js
//= require documents/pressure_ulser_m1322_m1324_c1.js
//= require documents/adl_iadls4_m1900_m1910_c1.js
//= require documents/adl_iadls1_m1800_m1830_c1.js
//= require documents/inpatient_facility_m2410_m2420_c1.js
//= require documents/status_risk_vaccine_m1040_m1055_trn_c1.js
//= require documents/stasis_ulcer_wound_m1330_m1342_c1.js
//= require documents/respiratory_cardiac_m1400_m1510_c1.js
//= require documents/types_sources_of_assistance_m2102_c1.js
//= require documents/emergent_care_m2300_m2310_c1.js
//= require documents/medications_m2004_m2015_c1.js
//= require documents/intervention_synopsis_m2400_c1.js
//= require documents/status_risk_vaccine_m1040_m1055_dc_c1.js
//= require documents/diagnosis_and_procedure_codes_m1011.js
//= require documents/diagnosis_and_procedure_codes_m1011_other_follow_up.js


jQuery(document).ready(function(){
    if(skipHasPageSignin()) return;
    if(cookieExist("numberOfTabs")){
        var currentNoTabs = currentNumberOfTabs();
        if (currentNoTabs == 1) {
            var url = window.location.protocol + "//" + window.location.host + "/web/multiple_tab.html";
            window.location = url;
        }
        var number = currentNoTabs + 1;
        document.cookie = "numberOfTabs=" + number;
    } else {
        document.cookie = "numberOfTabs=1";
    }
});

$( window ).on("beforeunload", function() {
    if(skipHasPageSignin()) return;
    var currentNoTabs = currentNumberOfTabs();
    var number = currentNoTabs - 1;
    if (number == 0) {
        Ext.Ajax.request({
            async: false,
            url: '/may_be_logging_out',
            method: 'GET'
        });
    }
    document.cookie = "numberOfTabs=" + number;
});

function skipHasPageSignin(){
    var res = false;
    var location_url = window.location.href.split("/")
    var signin = location_url[location_url.length - 1]
    if (signin == "signin" || signin == "multiple_tab.html"){
        res = true;
    }
    return res;
}

function currentNumberOfTabs(){
    var currentNumberOfTabs = 0;
    var allCookies = document.cookie;
    $.each(allCookies.split(/; */), function()  {
        var splitCookie = this.split('=');
        if (splitCookie[0] == "numberOfTabs") {
            currentNumberOfTabs = splitCookie[1];
        }
    });
    return parseInt(currentNumberOfTabs);
}

function tE(record, event){
    g = Ext.ComponentQuery.query('#episodes_list')[0];
    g.selectTreatmentAndEvent({episode_id: record, event_name: event}, function(){
        var name;
        console.log("event_name" +event);
        if (event == "recertification"){
            activityFormLoading("recertification_form", g);
        }else if(event == "unhold" || event == "discharge" || event =="hold"){
            activityFormLoading("treatment_activity_form", g);
        }
        if (event == "undo"){
            g.undoTreatment({episode_id: record, event_name: event}, function(){
                g.store.load();
            }, g);
        }

    }, g);
}

function activityFormLoading(name, g){
    g.loadNetzkeComponent({
        name: name, callback: function (w) {
            w.show();
            w.on('close', function () {
                if (w.closeRes === "ok") {
                    g.store.load();
                }
            }, g);
        }, scope: g
    });;
}

function tR(record, event){
    g = Ext.ComponentQuery.query('#episodes_list')[0];
    if (event == "mark_as_referral_received"){
        var w = new Ext.window.Window({
            width: "25%",
            height: "18%",
            modal: true,
            layout:'fit',
            buttons: [
                {
                    text: "",
                    tooltip: "OK",
                    iconCls: "ok_icon",
                    listeners: {
                        click: function(){
                            g.sendUpdatedReferralReceivedDate(w, record)
                        }
                    }
                },
                {
                    text: "",
                    tooltip: "Cancel",
                    iconCls: "cancel_icon",
                    listeners: {
                        click: function(){w.close();}
                    }
                }
            ],
            title: "Referral Received Date"
        });
        w.show();
        g.loadNetzkeComponent({name: "date_component", container:w, callback: function(w){
            w.show();
        }});
    }else if (event == "admit"){
        var w = new Ext.window.Window({
            width: "25%",
            height: "18%",
            modal: true,
            layout:'fit',
            buttons: [
                {
                    text: "",
                    tooltip: "OK",
                    iconCls: "ok_icon",
                    listeners: {
                        click: function(){
                            g.setStartOfCareDate(w, record)
                        }
                    }
                },
                {
                    text: "",
                    tooltip: "Cancel",
                    iconCls: "cancel_icon",
                    listeners: {
                        click: function(){w.close();}
                    }
                }
            ],
            title: "SOC Date"
        });
        w.show();
        g.loadNetzkeComponent({name: "soc_date_component", container:w, callback: function(w){
            w.show();
        }});
    }else if (event == "finalize_staffing"){
        Ext.MessageBox.alert("Success", "Your staffing has been finalized.");
        g.triggerReferralEvent({record_id: record, action: event});
    }else{
        g.triggerReferralEvent({record_id: record, action: event});
    }
}





function cookieExist(name){
    var cookiePresent = false;
    var allCookies = document.cookie;
    $.each(allCookies.split(/; */), function()  {
        var splitCookie = this.split('=');
        if (splitCookie[0] == name) {
            cookiePresent = true;
        }
    });
    return cookiePresent;
}


function registerVisitedEventHandlers(container, panelList){
    container.on('afterrender', function(){
        Ext.each(panelList, function(panelItemId, idx) {
            var panel = Ext.ComponentQuery.query(panelItemId)[0];
            // when tool icon clicked then change color of the panel
            var tool = panel.tools['pin'];
            tool.on('click', function(){
                panel.header.addCls('visited');
            });
            // when panel content changed then change color of the panel
            elements = panel.query('textfield, textarea, combobox, radiofield, checkboxfield, slider');
            Ext.each(elements, function(ele, index){
                ele.on('change', function(){
                    panel.header.addCls('visited');
                });
            });
        });
    });
}

function    registerContentChangeEventHandlers(container, panelList){
    Ext.each(panelList, function(panel, index) {
        var elements = panel.query("textarea");
        Ext.each(elements, function(el,index) {
            el.on('change', function(){
                var items = el.up().query('textarea');
                var data_present = false;
                for(var i=0; i < items.length;i++){
                    if(items[i].getValue() != ""){
                        data_present = true;
                        break;
                    }
                }
                if(data_present){
                    panel.addCls('non-empty');
                }
                else{
                    panel.removeCls('non-empty');
                }
            });
        });
    });
}

function assignTotalScore(){
    var balance = 0, gait = 0, total = 0;
    var balancePanel = Ext.ComponentQuery.query('#balance_panel')[0];
    var radioGroups = balancePanel.query('radiogroup');
    balance = getScore(radioGroups);
    var gaitPanel = Ext.ComponentQuery.query('#gait_panel')[0];
    var radioGroups = gaitPanel.query('radiogroup');
    gait = getScore(radioGroups);
    total = balance + gait;

    Ext.ComponentQuery.query('#balance_score')[0].setValue(balance);
    Ext.ComponentQuery.query('#gait_score')[0].setValue(gait);
    Ext.ComponentQuery.query('#total_score')[0].setValue(total);
}

function getScore(radioGroups){
    var score = 0;
    Ext.each(radioGroups, function(radioGroup, index){
        radioButtons = radioGroup.query("radiofield");
        Ext.each(radioButtons, function(radioButton, i){
            if(radioButton.value){
                score = score + parseInt(radioButton.score);
            }
        });
    });
    return score;
}

function copyTextToTextarea(window, text1){
    var details = Ext.ComponentQuery.query('#free_form_template_details')[0];
    if(text1.value){
        text1.setValue(text1.value + "\n" + details.value);
    }else{
        text1.setValue(details.value);
    }

    window.close();
}

//F2 event in forms
function freeFormTemplateWindowEvents(formScope){
    var elementsList = Ext.ComponentQuery.query('textarea, textfield');
    Ext.each(elementsList, function(ele, index){
        if (formScope.freeFormTemplate == undefined || formScope.freeFormTemplate == true){
            ele.enableKeyEvents = true;
            Ext.QuickTips.register({target: ele.getEl(), text: "Press F2 to select from existing template", dismissDelay: 1000000});
            //category setting
            ele.on('keydown', function(field, e, options){
                if(e.keyCode == 113){
                    formScope.selectTemplateCategory({template_category: ele.filter});
                    var w = new Ext.window.Window({
                        width: 800,
                        height: 400,
                        modal: true,
                        layout:'fit',
                        buttons: [
                            {
                                text: "Ok",
                                listeners: {
                                    click: function(){copyTextToTextarea(w, ele)}
                                }
                            },
                            {
                                text: "Cancel",
                                listeners: {
                                    click: function(){w.close();}
                                }
                            }
                        ],
                        title: "Templates"
                    });
                    w.show();
                    formScope.loadNetzkeComponent({name: "free_form_template_explorer_component", container:w, callback: function(w){
                        w.show();
                    }});
                }
            });
        }
    });
}

function createWoundPanel(woundPanel, woundDescriptionPanel, index){
    var newWoundPanel = new Ext.Panel(woundDescriptionPanel);
    newWoundPanel.title = "Wound Description " + index;
    newWoundPanel.itemId = "wound_description_" + index;
    newWoundPanel.hidden = false;
    var fields = newWoundPanel.query('textfield, numberfield, radiofield, datefield, timefield');
    Ext.each(fields, function(field, ind){
        field.name = field.name + index;
    });
    woundPanel.add(newWoundPanel);
}

// Form Panel Overrided in order to get rid of form border
Ext.define('Ext.netzke.xFormPanel', {
    extend        : 'Ext.form.Panel',
    alias         : 'widget.borderlessFormPanel',
    border        : false
});


Ext.define('Ext.window.Window', {
    extend : 'Ext.window.Window',
    minButtonWidth :'25px',
    onEsc : function() {
    },
    listeners: {
        afterrender: function (component, options) {
            if (component.alwaysOnTop) {
                if (!this.alwaysOnTopManager) {
                    this.alwaysOnTopManager = Ext.create('Ext.ZIndexManager');
                }
                this.alwaysOnTopManager.register(component);
            }
            if (this.alwaysOnTopManager) {
                /* Making sure the alwaysOnTopManager always has the highest zseed */
                if (Ext.ZIndexManager.zBase > this.alwaysOnTopManager.zseed) {
                    this.alwaysOnTopManager.zseed = this.alwaysOnTopManager.getNextZSeed();
                }
            }
        }
    }
});

Ext.define('Ext.button.Button', {
    extend : 'Ext.button.Button',
    arrowCls: ''

});

// ComboBox that gets options from the server (used in both grids and panels)
Ext.define('Ext.netzke.ComboBox', {
    extend        : 'Ext.form.field.ComboBox',
    alias         : 'widget.netzkeremotecombo',
    valueField    : 'field1',
    displayField  : 'field2',
    triggerAction : 'all',
    minChars      : 3,
    // WIP: Breaking - should not be 'true' if combobox is not editable
    // typeAhead     : true,

    initComponent : function(){
        var parentId = this.parentId || Ext.documentFormId;
        var modelName = parentId + "_" + this.name;
        Ext.define(modelName, {
            extend: 'Ext.data.Model',
            fields: ['field1', 'field2']
        });

        var store = new Ext.data.Store({
            model: modelName,
            proxy: {
                type: 'direct',
                directFn: Netzke.providers[parentId].getComboboxOptions,
                extraParams: {column: this.name},
                reader: {
                    type: 'array',
                    root: 'data'
                }
            }
        });

        // TODO: find a cleaner way to pass this.name to the server
        store.on('beforeload', function(self, params) {
            //params.params.column = this.name;
        },this);

        store.on('load', function(self, params) {
            if (!this.emptyText){
                this.emptyText = "---"; //General for all combo field.
                //this.emptyText = "Select " + this.fieldLabel //Depends on field label, changes the text.
            }
            self.insert(0, Ext.create(modelName, {field1: null, field2: this.emptyText}));
        }, this);

        // If inline data was passed (TODO: is this actually working?)
        if (this.store) store.loadData({data: this.store});

        this.store = store;
        this.callParent();
    },

    collapse: function(){
        // HACK: do not hide dropdown menu while loading items
        if( !this.store.loading ) this.callParent();
    }
});

/*
 Ext.Ajax.on('requestexception', function(conn,opt) {
 var exception = Ext.Msg.show({
 title: "",
 msg: "FasterNotes has encountered a loading error. Please refresh<br/>the page to try again. If you are still experiencing this issue, <br/>please contact customer support at (888) 255-8508.",
 icon: Ext.Msg.ERROR,
 buttons: Ext.Msg.OK,
 });
 exception.setPosition(400, 40);
 });
 */

Ext.override(Ext.selection.Model, {
    /**
     * this override fixes multiple bugs when store is a buffered type
     * and fixed a bug that causes the initial hasId to not work because
     * the store.gerById() method expects an ID and not the record
     * also forcing the double verification when the record is not found because
     * it places both checks in a single if statement
     * @param record
     * @returns {boolean}
     */
    storeHasSelected: function(record) {
        var store = this.store,
            records,
            len, id, i, m;


        if (record.hasId()) {
            return store.getById(record.getId());
        } else {
            if (store.buffered) {//on buffered stores the map holds the data items
                records = [];
                for (m in store.data.map) {
                    records = records.concat(store.data.map[m].value);
                }
            } else {
                records = store.data.items;
            }
            len = records.length;
            id = record.internalId;


            for (i = 0; i < len; ++i) {
                if (id === records[i].internalId) {
                    return true;
                }
            }
        }
        return false;
    }
});

//function for enabling and disabling actions in grid panel

function enableDisableActions(actions, value, g){
  Ext.each(actions, function(el){
    g.actions[el].setDisabled(value);
  });
}

//Functions for getting tree panel node => start

function findChild(parentNode, text){
    var node = null;

    function recurse(pNode) {
        var childNodes = pNode.childNodes;
        for (var i = 0; i < childNodes.length; i++) {
            var childNode = childNodes[i];
            if(childNode.raw.text.indexOf(text) != -1){
                node = childNode;
                break;
            } else if(childNode.isLeaf() == false){
                childNode.expand();
                recurse(childNode, text);
            }
        }
    }
    recurse(parentNode);
    return node;
}

function getTreeNode(chart, nodeName, selector){
    var rootNode = chart.getRootNode();
    var node = null;
    if(selector != ""){
        node = findChild(rootNode, selector);
        if(node) node = findChild(node, nodeName);
    } else {
        node = findChild(rootNode, nodeName);
    }
    return node;
}
//Functions for getting tree panel node => end


String.prototype.capitalize = function() {
    return this.charAt(0).toUpperCase() + this.slice(1);
}

String.prototype.humanize = function() {
    var frags = this.split('_');
    for (i=0; i<frags.length; i++) {
        frags[i] = frags[i].capitalize();
    }
    return frags.join(' ');
}

function formattedAmount(value){
    return Ext.util.Format.usMoney(value);
}

function isNumberKey(evt){
    var charCode = (evt.which) ? evt.which : event.keyCode
    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
        return false;
    }
    return true;
}

var store = Ext.create('Ext.data.Store', {
    fields:['targetcode', 'sourcecode'],
    data:{'items':[
           ]},
    proxy: {
        type: 'memory',
        reader: {
            type: 'json',
            root: 'items'
        }
    }

});

Ext.define('gemgrid', {
    extend: 'Ext.grid.Panel',
    store: store,
    title: false,
    item_id: 'mapping_grid_gem',
    columns: [
        { text: 'Sourcecode', dataIndex: 'sourcecode', width: '20%', tdCls: 'wrap', header: "ICD9"},
        { text: 'Targetcode',  dataIndex: 'targetcode', width: '75%', tdCls: 'wrap', header: "ICD10"},
    ],
    initComponent: function () {
        this.callParent();
        this.setHeight(this.height);
        this.setWidth(this.width);
        this.store.removeAll();
    }
});

Ext.define('grouper', {
    extend: 'Ext.panel.Panel',

    initComponent: function () {
        var me = this;
        grouperRes =  this.data;
        var drawComponent = Ext.create('Ext.draw.Component', {});
        Ext.applyIf(me, {
            items: [drawComponent]
        });
        me.callParent();
    },
    drawStuff: function() {
        console.log(this.items.items[0]);

        surface = this.items.items[0].surface;
        console.log("Grouper........");
        console.log(surface);
        box1_y = 50;
        box1_x = 100;
        box2_x = 200;
        box2_y = 50;
        box1_width = 75;
        box2_width = 75;
        box3_x = 300;
        box3_y = 50;
        box3_width = 75;
        box4_x = 400;
        box4_y = 50;
        box4_width = 75;

        box5_x = 500;
        box5_y = 50;
        box5_width = 75;

        box_height = 120;
        box_2_height =150;

        //data = [["1", "1"], ["2", ""], ["3", ""], ["4", ""], ["5", ""]];
        data = grouperRes.b1;

        part_height = box_height / data.length;
        part_number = 0;
        for (var k in data) {
            part_number = part_number + 1;
            color = '#ffffff';
            if (data[part_number - 1][1] != "") {
                color = '#34A1FB';
            }

            box_data = {
                type: 'path',
                stroke: '#7F7C7D',
                fill: color,
                'stroke-width': "1",
                path: 'M' + box1_x + ' ' + (box1_y + part_number * part_height) + ' v -30 h ' + box1_width + ' v 30  Z'
            }

            if (data[part_number - 1][1] != "") {
                box_data['group'] = 'highlight';
            }
            console.log(box_data);
            surface.add(box_data).show(true);
            surface.add({
                type: 'text',
                x: 105,
                y: 30,
                width: 40,
                height: 30,
                font: '10px Open Sans',
                fillOpacity: 0.2,
                text: 'Grouping Step'
            }).show(true);
            surface.add({
                type: 'text',
                x: 30 + box1_x,
                y: (box1_y + part_number * part_height) - 15,
                width: 40,
                height: 30,
                fontWeight: 'bold',
                font: '12px Open Sans',
                text: data[part_number - 1][0]
            }).show(true);

            if (data[part_number - 1][1] != "") {
                surface.add({
                    type: 'text',
                    x: 3 + box1_x + box1_width,
                    y: (box1_y + part_number * part_height) - 15,
                    width: 40,
                    height: 30,
                    alignTo: 'center',
                    text: ((data[part_number - 1][1] == -1) ? 0 : data[part_number - 1][1])
                }).show(true);

            }

            highlight = surface.getGroup('highlight');

            // Animate the circles down
            /* highlight.animate({
             duration: 5000,
             to: {
             translate: {
             x: 200
             }
             }
             });*/


            /*highlight.animate({
             to: {
             opacity: 0
             }
             });*/
        }
        //data = [["4+ C", 7], ["2-3 B", ""], ["0-1 A", ""]];
        data = grouperRes.b2;
        part_height = box_height / data.length;
        part_number = 0;
        for (var k in data) {
            part_number = part_number + 1;
            color = '#ffffff';
            if (data[part_number - 1][1] != "") {
                color = '#34A1FB';
            }

            box_data = {
                type: 'path',
                stroke: '#7F7C7D',
                fill: color,
                'stroke-width': "1",
                path: 'M' + box2_x + ' ' + (box2_y  + part_number * part_height) + ' v -45 h ' + box2_width + ' v 45  Z'
            }

            if (data[part_number - 1][1] != "") {
                box_data['group'] = 'highlight';
            }
            console.log(box_data);
            surface.add(box_data).show(true);
            surface.add({
                type: 'text',
                x: 205,
                y: 30,
                width: 40,
                height: 30,
                font: '10px Open Sans',
                fillOpacity: 0.3,
                text: 'Clinical Points'
            }).show(true);
            surface.add({
                type: 'text',
                x: 20 + box2_x,
                y: (box2_y + part_number * part_height) - 20,
                width: 40,
                height: 30,
                fontWeight: 'bold',
                font: '12px Open Sans',
                text: data[part_number - 1][0]
            }).show(true);

            if (data[part_number - 1][1] != "") {
                surface.add({
                    type: 'text',
                    x: 3 + box2_x + box2_width,
                    y: (box2_y + part_number * part_height) - 20,
                    width: 40,
                    height: 30,
                    text: ((data[part_number - 1][1] == -1) ? 0 : data[part_number - 1][1])
                }).show(true);

            }

            highlight = surface.getGroup('highlight');

            // Animate the circles down
            /* highlight.animate({
             duration: 5000,
             to: {
             translate: {
             x: 200
             }
             }
             });*/


            /*highlight.animate({
             to: {
             opacity: 0
             }
             });*/
        }
        //data=[["16+ H", ""], ["15 G", ""], ["0-14 F", 7]];
        data= grouperRes.b3;
        part_height = box_height / data.length;
        part_number = 0;
        for (var k in data) {
            part_number = part_number + 1;
            color = '#ffffff';
            if (data[part_number - 1][1] != "") {
                color = '#34A1FB';
            }

            box_data = {
                type: 'path',
                stroke: '#7F7C7D',
                fill: color,
                'stroke-width': "1",
                path: 'M' + box3_x + ' ' + (box3_y  + part_number * part_height) + ' v -45 h ' + box3_width + ' v 45  Z'
            }

            if (data[part_number - 1][1] != "") {
                box_data['group'] = 'highlight';
            }
            console.log(box_data);
            surface.add(box_data).show(true);
            surface.add({
                type: 'text',
                x: 305,
                y: 30,
                width: 80,
                height: 30,
                font: '10px Open Sans',
                fillOpacity: 0.3,
                text: 'Functional Points'
            }).show(true);
            surface.add({
                type: 'text',
                x: 20 + box3_x,
                y: (box3_y + part_number * part_height) - 20,
                width: 40,
                height: 30,
                fontWeight: 'bold',
                font: '12px Open Sans',
                text: data[part_number - 1][0]
            }).show(true);

            if (data[part_number - 1][1] != "") {
                surface.add({
                    type: 'text',
                    x: 3 + box3_x + box3_width,
                    y: (box3_y + part_number * part_height) - 20,
                    width: 40,
                    height: 30,
                    alignTo: 'center',
                    text: ((data[part_number - 1][1] == -1) ? 0 : data[part_number - 1][1])
                }).show(true);

            }

            highlight = surface.getGroup('highlight');

            // Animate the circles down
            /* highlight.animate({
             duration: 5000,
             to: {
             translate: {
             x: 200
             }
             }
             });*/


            /*highlight.animate({
             to: {
             opacity: 0
             }
             });*/
        }

        //data = [["11-13 P", ""], ["10 N", ""], ["7-9 M", 7], ["6 L", ""], ["0-5 K", ""]];
        data =  grouperRes.b4;
        part_height = box_height / data.length;
        part_number = 0;
        for (var k in data) {
            part_number = part_number + 1;
            color = '#ffffff';
            if (data[part_number - 1][1] != "") {
                color = '#34A1FB';
            }

            box_data = {
                type: 'path',
                stroke: '#7F7C7D',
                fill: color,
                'stroke-width': "1",
                path: 'M' + box4_x + ' ' + (box4_y + part_number * part_height) + ' v -30 h ' + box4_width + ' v 30  Z'
            }

            if (data[part_number - 1][1] != "") {
                box_data['group'] = 'highlight';
            }
            console.log(box_data);
            surface.add(box_data).show(true);
            surface.add({
                type: 'text',
                x: 405,
                y: 30,
                width: 120,
                height: 30,
                font: '10px Open Sans',
                fillOpacity: 0.2,
                text: 'Service Points'
            }).show(true);
            surface.add({
                type: 'text',
                x: 20 + box4_x,
                y: (box4_y + part_number * part_height) - 15,
                width: 40,
                height: 30,
                fontWeight: 'bold',
                font: '12px Open Sans',
                text: data[part_number - 1][0]
            }).show(true);

            if (data[part_number - 1][1] != "") {
                surface.add({
                    type: 'text',
                    x: 3 + box4_x + box4_width,
                    y: (box4_y + part_number * part_height) - 15,
                    width: 40,
                    height: 30,
                    text: ((data[part_number - 1][1] == -1) ? 0 : data[part_number - 1][1])
                }).show(true);

            }

            highlight = surface.getGroup('highlight');

            // Animate the circles down
            /* highlight.animate({
             duration: 5000,
             to: {
             translate: {
             x: 200
             }
             }
             });*/


            /*highlight.animate({
             to: {
             opacity: 0
             }
             });*/
        }
        //data = [["99+ X", ""], ["49-98 W", ""], ["28-48 V", ""], ["1-14 T", 7], ["0 S", ""]];
        data = grouperRes.b5;
        part_height = box_height / data.length;
        part_number = 0;
        for (var k in data) {
            part_number = part_number + 1;
            color = '#ffffff';
            if (data[part_number - 1][1] != "") {
                color = '#34A1FB';
            }

            box_data = {
                type: 'path',
                stroke: '#7F7C7D',
                fill: color,
                'stroke-width': "1",
                path: 'M' + box5_x + ' ' + (box5_y + part_number * part_height) + ' v -26 h ' + box5_width + ' v 26  Z'
            }

            if (data[part_number - 1][1] != "") {
                box_data['group'] = 'highlight';
            }
            console.log(box_data);
            surface.add(box_data).show(true);
            surface.add({
                type: 'text',
                x: 505,
                y: 30,
                width: 160,
                height: 30,
                font: '10px Open Sans',
                fillOpacity: 0.2,
                text: 'NRS Supply Points'
            }).show(true);
            surface.add({
                type: 'text',
                x: 20 + box5_x,
                y: (box5_y + part_number * part_height) - 15,
                width: 40,
                height: 30,
                fontWeight: 'bold',
                font: '12px Open Sans',
                text: data[part_number - 1][0]
            }).show(true);

            if (data[part_number - 1][1] != "") {
                surface.add({
                    type: 'text',
                    x: 3 + box5_x + box5_width,
                    y: (box5_y + part_number * part_height) - 15,
                    width: 40,
                    height: 30,
                    text: ((data[part_number - 1][1] == -1) ? 0 : data[part_number - 1][1])
                }).show(true);

            }

        }

    }
});

